<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Bots - STC Trading System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #ffffff;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #00d4ff;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat .label {
            font-size: 12px;
            color: #8892b0;
            margin-bottom: 5px;
        }

        .header-stat .value {
            font-size: 24px;
            font-weight: 700;
        }

        .header-stat.profit .value {
            color: #00ff88;
        }

        .header-stat.loss .value {
            color: #ff4757;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(145deg, #1a1f3a, #14182b);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #2d3561;
        }

        .metric-card .label {
            font-size: 13px;
            color: #8892b0;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #00d4ff;
        }

        .metric-card .subtitle {
            font-size: 12px;
            color: #525f7f;
            margin-top: 5px;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: linear-gradient(145deg, #1a1f3a, #14182b);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #2d3561;
            height: 350px;
            display: flex;
            flex-direction: column;
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #00d4ff;
            font-size: 18px;
            flex-shrink: 0;
        }

        .chart-card canvas {
            flex: 1;
            min-height: 0;
        }

        .bots-table {
            background: linear-gradient(145deg, #1a1f3a, #14182b);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #2d3561;
            margin-bottom: 30px;
        }

        .bots-table h3 {
            margin-bottom: 20px;
            color: #00d4ff;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #0f1729;
        }

        th {
            padding: 15px;
            text-align: left;
            font-size: 13px;
            color: #8892b0;
            font-weight: 600;
            border-bottom: 2px solid #2d3561;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #1a1f3a;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #1a1f3a;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-running {
            background: #00ff8844;
            color: #00ff88;
        }

        .status-stopped {
            background: #ff475744;
            color: #ff4757;
        }

        .status-paused {
            background: #ffa50044;
            color: #ffa500;
        }

        .profit-positive {
            color: #00ff88;
        }

        .profit-negative {
            color: #ff4757;
        }

        .gale-level {
            background: #2d3561;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00d4ff22;
            border: 1px solid #00d4ff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 12px;
            color: #00d4ff;
        }

        .no-bots {
            text-align: center;
            padding: 60px 20px;
            color: #525f7f;
        }

        .no-bots-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .updating {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="refresh-indicator" id="refreshIndicator">
        Actualizando...
    </div>

    <div class="header">
        <h1>ðŸ“Š Monitor de Bots - STC Trading System</h1>
        <div class="header-stats">
            <div class="header-stat profit">
                <div class="label">Profit Total</div>
                <div class="value" id="totalProfit">$0.00</div>
            </div>
            <div class="header-stat">
                <div class="label">Bots Activos</div>
                <div class="value" id="activeBots">0</div>
            </div>
            <div class="header-stat">
                <div class="label">Win Rate</div>
                <div class="value" id="globalWinRate">0%</div>
            </div>
        </div>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="label">Secuencias CALL</div>
            <div class="value" id="callSequences">0</div>
            <div class="subtitle">Activas ahora</div>
        </div>
        <div class="metric-card">
            <div class="label">Secuencias PUT</div>
            <div class="value" id="putSequences">0</div>
            <div class="subtitle">Activas ahora</div>
        </div>
        <div class="metric-card">
            <div class="label">Secuencias Ganadas</div>
            <div class="value" id="wonSequences">0</div>
            <div class="subtitle">Total acumulado</div>
        </div>
        <div class="metric-card">
            <div class="label">Riesgo Activo</div>
            <div class="value" id="activeRisk">$0.00</div>
            <div class="subtitle">En trades abiertos</div>
        </div>
    </div>

    <div class="charts-section">
        <div class="chart-card">
            <h3>ðŸ’° Profit Over Time</h3>
            <canvas id="profitChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>ðŸ“Š DistribuciÃ³n de Gales</h3>
            <canvas id="galeDistChart"></canvas>
        </div>
    </div>

    <div class="bots-table">
        <h3>ðŸ¤– Bots Activos</h3>
        <table id="botsTable">
            <thead>
                <tr>
                    <th>Bot</th>
                    <th>Estrategia</th>
                    <th>Par</th>
                    <th>Estado</th>
                    <th>Gales Activos</th>
                    <th>Win Rate</th>
                    <th>Profit</th>
                    <th>Ãšltima SeÃ±al</th>
                </tr>
            </thead>
            <tbody id="botsTableBody">
                <tr>
                    <td colspan="8" class="no-bots">
                        <div class="no-bots-icon">ðŸ¤–</div>
                        <div>No hay bots activos. Crea un bot desde el panel de control.</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        let profitChart = null;
        let galeDistChart = null;
        let profitData = [];
        let updateInterval = null;

        function initCharts() {
            const profitCtx = document.getElementById('profitChart').getContext('2d');
            profitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Profit Acumulado',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#1a1f3a'
                            },
                            ticks: {
                                color: '#8892b0'
                            }
                        },
                        y: {
                            grid: {
                                color: '#1a1f3a'
                            },
                            ticks: {
                                color: '#8892b0',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            const galeCtx = document.getElementById('galeDistChart').getContext('2d');
            galeDistChart = new Chart(galeCtx, {
                type: 'bar',
                data: {
                    labels: ['G0', 'G1', 'G2', 'G3', 'G4', 'G5', 'G6', 'G7'],
                    datasets: [
                        {
                            label: 'CALL',
                            data: [0, 0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: '#00ff88'
                        },
                        {
                            label: 'PUT',
                            data: [0, 0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: '#ff4757'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#8892b0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#1a1f3a'
                            },
                            ticks: {
                                color: '#8892b0'
                            }
                        },
                        y: {
                            grid: {
                                color: '#1a1f3a'
                            },
                            ticks: {
                                color: '#8892b0',
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        async function fetchMonitorData() {
            try {
                const response = await fetch('/api/monitor/all');
                const data = await response.json();
                
                if (data.success) {
                    updateDashboard(data.bots);
                }
            } catch (error) {
                console.error('Error fetching monitor data:', error);
            }
        }

        function updateDashboard(bots) {
            let totalProfit = 0;
            let activeBots = 0;
            let totalWins = 0;
            let totalLosses = 0;
            let callSequences = 0;
            let putSequences = 0;
            let wonSequences = 0;
            let activeRisk = 0;
            let galeDistCall = [0, 0, 0, 0, 0, 0, 0, 0];
            let galeDistPut = [0, 0, 0, 0, 0, 0, 0, 0];

            bots.forEach(bot => {
                if (bot.running) activeBots++;

                const botStats = bot.stats.bot_stats || {};
                totalProfit += botStats.total_profit || 0;
                totalWins += botStats.winning_trades || 0;
                totalLosses += botStats.losing_trades || 0;

                if (bot.stats.gale_stats) {
                    const galeStats = bot.stats.gale_stats;
                    wonSequences += galeStats.won_sequences || 0;

                    if (galeStats.call_active) callSequences++;
                    if (galeStats.put_active) putSequences++;

                    if (galeStats.active_sequences) {
                        galeStats.active_sequences.forEach(seq => {
                            activeRisk += seq.total_invested || 0;
                        });
                    }

                    if (galeStats.wins_by_gale) {
                        for (let i = 0; i < 8; i++) {
                            galeDistCall[i] += galeStats.wins_by_gale.CALL[i] || 0;
                            galeDistPut[i] += galeStats.wins_by_gale.PUT[i] || 0;
                        }
                    }
                }
            });

            const globalWinRate = totalWins + totalLosses > 0 
                ? ((totalWins / (totalWins + totalLosses)) * 100).toFixed(1)
                : 0;

            document.getElementById('totalProfit').textContent = '$' + totalProfit.toFixed(2);
            document.getElementById('totalProfit').className = 'value ' + (totalProfit >= 0 ? 'profit-positive' : 'profit-negative');
            document.getElementById('activeBots').textContent = activeBots;
            document.getElementById('globalWinRate').textContent = globalWinRate + '%';
            document.getElementById('callSequences').textContent = callSequences;
            document.getElementById('putSequences').textContent = putSequences;
            document.getElementById('wonSequences').textContent = wonSequences;
            document.getElementById('activeRisk').textContent = '$' + activeRisk.toFixed(2);

            updateProfitChart(totalProfit);
            updateGaleDistChart(galeDistCall, galeDistPut);
            updateBotsTable(bots);
        }

        function updateProfitChart(currentProfit) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

            profitData.push({ time: timeLabel, profit: currentProfit });
            if (profitData.length > 20) profitData.shift();

            profitChart.data.labels = profitData.map(d => d.time);
            profitChart.data.datasets[0].data = profitData.map(d => d.profit);
            profitChart.update('none');
        }

        function updateGaleDistChart(callData, putData) {
            galeDistChart.data.datasets[0].data = callData;
            galeDistChart.data.datasets[1].data = putData;
            galeDistChart.update('none');
        }

        function updateBotsTable(bots) {
            const tbody = document.getElementById('botsTableBody');
            
            if (bots.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-bots">
                            <div class="no-bots-icon">ðŸ¤–</div>
                            <div>No hay bots activos. Crea un bot desde el panel de control.</div>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            bots.forEach(bot => {
                const config = bot.config;
                const stats = bot.stats.bot_stats || {};
                const galeStats = bot.stats.gale_stats || {};
                
                const status = bot.running ? 'running' : 'stopped';
                const statusText = bot.running ? 'Ejecutando' : 'Detenido';
                
                const winRate = stats.win_rate || 0;
                const profit = stats.total_profit || 0;
                const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';

                let galeInfo = '-';
                if (galeStats.active_sequences && galeStats.active_sequences.length > 0) {
                    galeInfo = galeStats.active_sequences.map(seq => 
                        `<span class="gale-level">${seq.direction} G${seq.gale_level}</span>`
                    ).join(' ');
                }

                const lastSignal = stats.last_signal_time 
                    ? new Date(stats.last_signal_time * 1000).toLocaleTimeString('es-ES')
                    : '-';

                html += `
                    <tr>
                        <td><strong>${config.name}</strong></td>
                        <td>${config.strategy_name}</td>
                        <td>${config.symbol}</td>
                        <td><span class="status-badge status-${status}">${statusText}</span></td>
                        <td>${galeInfo}</td>
                        <td>${winRate.toFixed(1)}%</td>
                        <td class="${profitClass}">$${profit.toFixed(2)}</td>
                        <td>${lastSignal}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function startAutoRefresh() {
            const indicator = document.getElementById('refreshIndicator');
            
            updateInterval = setInterval(async () => {
                indicator.classList.add('updating');
                await fetchMonitorData();
                setTimeout(() => {
                    indicator.classList.remove('updating');
                }, 500);
            }, 5000);
        }

        window.addEventListener('load', () => {
            initCharts();
            fetchMonitorData();
            startAutoRefresh();
        });

        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
